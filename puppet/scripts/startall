#!/bin/dash

echo 'clean up pre-generated keys for Tor HS'
rm -f /var/lib/tor/{mail,postgresql,tahoe,webmail}/*
service tor start

echo 'waiting a bit'
sleep 5

echo 'Set up tahoe tub.location'
location=$(cat /var/lib/tor/tahoe/hostname)
for i in client introducer storage; do
  if [ -f /var/lib/tahoe-lafs/$i/tahoe.cfg ]; then
    echo "  ${i}"
    sed -i "s/CHANGEME/${location}/g" /var/lib/tahoe-lafs/$i/tahoe.cfg
    su -c "/usr/local/bin/tahoe-service start ${i}" $i
  fi
done
echo

echo 'Should mount Tahoe "filesystem" now'

service cron start
service ssh start

if [ -f /etc/init.d/postgresql ]; then
  service postgresql start
  service spampd start
  service postfix start
  service dovecot start
fi

echo
echo 'SYSTEM READY'
echo

if [ -d /var/lib/tahoe-lafs/introducer/private ]; then
  echo 'introducer furl: '
  cat /var/lib/tahoe-lafs/introducer/private/introducer.furl
  echo 'introducer log port: '
  cat /var/lib/tahoe-lafs/introducer/private/logport.furl
fi

echo 'Entering loop'
# stupid while in order to keep it up
while true; do sleep 1; done
echo 'GOODBYE'
